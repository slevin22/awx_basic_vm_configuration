---
- name: install proxmoxer
  ansible.builtin.pip:
    name: 
      - "proxmoxer"
      - "paramiko"
    state: present
  delegate_to: localhost
  become: false

- name: Set proxmox variables
  ansible.builtin.set_fact:
    proxmox_api_host: "{{ proxmox_hosts[proxmox_node] }}"
    proxmox_user:     "{{ lookup('env', 'PROXMOX_USER') }}"
    proxmox_username: "{{ lookup('env', 'PROX_USERNAME') }}"
    proxmox_password: "{{ lookup('env',' PROXMOX_PASSWORD') }}"
    lxc_vmid: "{{ proxmox_vmid }}"
    lxc_distro: "{{ proxmox_ostype }}" # Options: debian, redhat (for apt or yum/dnf commands)

- name: Ensure the target container is running
  community.proxmox.proxmox:
    api_host: "{{ proxmox_api_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    vmid: "{{ lxc_vmid }}"
    state: started
  delegate_to: localhost
  become: false

- name: host execution block
  vars:
    ansible_user: "{{ proxmox_username }}"
    ansible_password: "{{ proxmox_password }}"
  block:

  - name: 1. Install OpenSSH Server and update packages (Debian/Ubuntu)
    ansible.builtin.shell: "pct exec {{ lxc_vmid }} -- apt update && apt install -y openssh-server sudo"
    when: lxc_distro == 'debian'
    delegate_to: "{{ proxmox_host_name }}"
    become: false

  - name: 2. Create the '{{ ansible_user_name }}' user
    ansible.builtin.shell: "pct exec {{ lxc_vmid }} -- useradd -m -s /bin/bash {{ ansible_user_name }}"
    delegate_to: "{{ proxmox_host_name }}"
    become: false

  - name: 3. Setup SSH directory and inject public key
    ansible.builtin.shell: |
      pct exec {{ lxc_vmid }} -- bash -c "
        mkdir -p /home/{{ ansible_user_name }}/.ssh && \
        echo '{{ ssh_public_key }}' > /home/{{ ansible_user_name }}/.ssh/authorized_keys && \
        chown -R {{ ansible_user_name }}:{{ ansible_user_name }} /home/{{ ansible_user_name }}/.ssh && \
        chmod 700 /home/{{ ansible_user_name }}/.ssh && \
        chmod 600 /home/{{ ansible_user_name }}/.ssh/authorized_keys
      "
    delegate_to: "{{ proxmox_host_name }}"
    become: false

  - name: 4. Add '{{ ansible_user_name }}' user to sudoers with NOPASSWD
    ansible.builtin.shell: "pct exec {{ lxc_vmid }} -- echo '{{ ansible_user_name }} ALL=(ALL) NOPASSWD: ALL' | tee -a /etc/sudoers.d/{{ ansible_user_name }}-nopasswd"
    delegate_to: "{{ proxmox_host_name }}"
    become: false

  - name: 5. Restart the SSH service to apply changes
    ansible.builtin.shell: "pct exec {{ lxc_vmid }} -- systemctl restart sshd"
    delegate_to: "{{ proxmox_host_name }}"
    become: false

  - name: 6. Verification message
    ansible.builtin.debug:
      msg: "LXC container (VMID: {{ lxc_vmid }}) should now have SSH enabled. Use the container's IP address and the user '{{ ansible_user_name }}' to connect."