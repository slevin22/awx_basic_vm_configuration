---
- name: install proxmoxer
  ansible.builtin.pip:
    name: 
      - "proxmoxer"
      - "paramiko"
    state: present
  delegate_to: localhost
  become: false

- name: Set proxmox variables
  ansible.builtin.set_fact:
    proxmox_api_host: "{{ proxmox_hosts[proxmox_node] }}"
    proxmox_user:     "{{ lookup('env', 'PROXMOX_USER') }}"
    proxmox_password: "{{ lookup('env',' PROXMOX_PASSWORD') }}"
    lxc_vmid: "{{ proxmox_vmid }}"
    lxc_distro: "{{ proxmox_ostype }}" # Options: debian, redhat (for apt or yum/dnf commands)

- name: Ensure the target container is running
  community.proxmox.proxmox:
    api_host: "{{ proxmox_api_host }}"
    api_user: "{{ proxmox_user }}"
    api_password: "{{ proxmox_password }}"
    vmid: "{{ lxc_vmid }}"
    state: started
  delegate_to: localhost
  become: false

- name: host execution block
  vars:
    ansible_user: "{{ lookup('env', 'PROX_USERNAME') }}"
    ansible_password: "{{ lookup('env',' PROXMOX_PASSWORD') }}"
    ansible_become_password: "{{ lookup('env',' PROXMOX_PASSWORD') }}"
    proxmox_api_host: "{{ proxmox_hosts[proxmox_node] }}"
    uid: "1515"
    lxc_vmid: "{{ proxmox_vmid }}"
    lxc_distro: "{{ proxmox_ostype }}" # Options: debian, redhat (for apt or yum/dnf commands)
  become_method: sudo
  become_user: root 
  become: true
  block:

  - name: Install OpenSSH Server and update packages (Debian/Ubuntu)
    ansible.builtin.shell: "/usr/sbin/pct exec {{ lxc_vmid }} -- apt update && apt install -y openssh-server sudo"
    when: lxc_distro == 'debian'
    delegate_to: "{{ proxmox_api_host }}"
    ignore_errors: true
    timeout: 300

  - name: Create the '{{ ansible_user_name }}' user
    ansible.builtin.shell: "/usr/sbin/pct exec {{ lxc_vmid }} -- useradd -u {{ uid }} -m -s /bin/bash {{ ansible_user_name }}"
    delegate_to: "{{ proxmox_api_host }}"
    ignore_errors: true
    timeout: 30

  - name: Setup SSH directory and inject public key
    ansible.builtin.shell: |
      /usr/sbin/pct exec {{ lxc_vmid }} -- bash -c "
        mkdir -p /home/{{ ansible_user_name }}/.ssh && \
        echo '{{ ssh_public_key }}' > /home/{{ ansible_user_name }}/.ssh/authorized_keys && \
        chown -R {{ ansible_user_name }}:{{ ansible_user_name }} /home/{{ ansible_user_name }}/.ssh && \
        chmod 700 /home/{{ ansible_user_name }}/.ssh && \
        chmod 600 /home/{{ ansible_user_name }}/.ssh/authorized_keys && \
        usermod -aG sudo {{ ansible_user_name }}
      "
    delegate_to: "{{ proxmox_api_host }}"
    timeout: 10

  - name: Add '{{ ansible_user_name }}' user to sudoers with NOPASSWD
    ansible.builtin.shell: |
      /usr/sbin/pct exec {{ lxc_vmid }} -- sh -c "
        echo '{{ ansible_user_name }} ALL=(ALL) NOPASSWD: ALL' | tee /etc/sudoers.d/{{ ansible_user_name }}-nopasswd
      "
    delegate_to: "{{ proxmox_api_host }}"
    timeout: 10

  - name: Restart the SSH service to apply changes
    ansible.builtin.shell: "/usr/sbin/pct exec {{ lxc_vmid }} -- systemctl restart sshd"
    delegate_to: "{{ proxmox_api_host }}"
    timeout: 30
    ignore_errors: true
